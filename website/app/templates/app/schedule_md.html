{% extends "app/base.html" %}

{% block title %} Schedule rehearsals {% endblock %}

{% block content %} 



<datalist id = 'pieces'>
    <option value = "None">None</option>
    {% for piece in piece_list %}
    <option value = "{{piece.name}}">{{piece.name}}</option>
    {% endfor %}
</datalist>

<form action = "{% url 'save_schedule'%}" id = 'save' method = 'post'> 
{% csrf_token %}
<table class = 'schedule'>
    <tr>
        <th class = 'schedule_left'>  </th>
        {% for day in days %}
        <th>{{day}}</th>
        {% endfor %}
    </tr>

    {% for time, row in data_colors %}
        <tr>
            <th class = 'schedule_left'>{{time}}</th>
            {% for day, block, color in row %}
            <td style = 'background-color: {{color}}'>
                <input type = 'text' class = "block {{color}}" id="block_{{day}}_{{time}}" list = "pieces" name = "{{day}} {{time}}" value = "{{block}}" style = "background-color: {{color}}" />
            </td>
            {% endfor %}
        </tr>
    {% endfor %}
</table>
</form>
<button class = 'mcalpin hover_button'>mcalpin</button>{% for piece in piece_list %}<button class = 'button_{{piece.name}} hover_button'>{{piece.name}}</button>{% endfor %}
<br> 

<button form = 'save' class = 'clickable'>Save</button>
<br>

<div class = 'secret'>
    (Arrays that Javascript needs to access)
    <div class = 'mcalpin'>{{mcalpin}}</div>
    <div class = 'days'>{{days}}</div>
    <div class = 'times'>{{times}}</div> 
    <div class = 'piece_names'>{{piece_names}}</div>
    {% for piece in piece_list %}
    <div class = '{{piece.name}}_max'>{{piece.group_size}}</div>
    <div class = '{{piece.name}}'>{{piece.availability}}</div>
    {% endfor %}
</div>



<script>
    function to_array(input_str){
        no_quotes = input_str.replaceAll('\'', '') // no quotes 
        no_spaces = no_quotes.replaceAll(' ', '')
        stripped = no_spaces.slice(1, -1);
        return stripped.split(',');
    }
    // idk why but if I try to merge queryselector into the function it crashes so here are 3 long lines 
    mcalpin = to_array(document.querySelector('div.mcalpin').textContent)
    days = to_array(document.querySelector('div.days').textContent)
    times = to_array(document.querySelector('div.times').textContent)
    pieces = to_array(document.querySelector('div.piece_names').textContent)

    hidden = false;
    button_mcalpin = document.querySelector('button.mcalpin');
    function update_hidden(button, availability, max) {
        hidden = !hidden;
        blocks = document.querySelectorAll('input.block')
        for (const block of blocks){
            if (hidden){
                day = block.name.split(' ')[0]
                time = block.name.split(' ')[1]
                num = 7*times.indexOf(time) + days.indexOf(day)
                if (availability[num] != max){ // if mcalpin is not available hide it
                    block.style = 'background-color: #999999; color: #999999';
                }
                else { // this resets any other filters
                    color = block.className.split(' ')[1] 
                    block.style = 'background-color: '+color+ ';';
                }
            }
            else {
                color = block.className.split(' ')[1] 
                block.style = 'background-color: '+color+ ';';
            }
        }
    }
    
    button_mcalpin.addEventListener("mouseenter", function () {update_hidden(button_mcalpin, mcalpin, 1)});
    button_mcalpin.addEventListener("mouseleave", function () {update_hidden(button_mcalpin, mcalpin, 1)});
    for (const piece of pieces){
        let max = Number(document.querySelector('div.'+piece+'_max').textContent)
        let array = to_array(document.querySelector('div.'+piece).textContent)
        let button = document.querySelector('button.button_'+piece)
        button.addEventListener('mouseenter', function() {update_hidden(button, array, max);})
        button.addEventListener('mouseleave', function() {update_hidden(button, array, max);})
    }
</script>

{% endblock %} 